name: "Install python env"
description: "Install cached python env with poetry"

runs:
  using: "composite"
  steps:

  - name: Cache Python
    uses: actions/cache@v4
    with:
      path: /opt/hostedtoolcache/Python/3.12.1
      key: python-3.12.1

  - name: Install Python
    uses: actions/setup-python@v5
    with:
      python-version: 3.12.1

  # https://www.peterbe.com/plog/install-python-poetry-github-actions-faster
  - name: Cache $HOME/.local
    uses: actions/cache@v4
    with:
      path: ~/.local
      key: dotlocal-${{ runner.os }}-${{ hashFiles('.github/actions/install-python-env/action.yml') }}

  - name: Install Poetry
    uses: abatilo/actions-poetry@v2

  # https://stackoverflow.com/questions/62977821/how-to-cache-poetry-install-for-github-actions
  - name: Cache venv
    id: cache-venv
    uses: actions/cache@v4
    with:
      path: .venv
      key: venv-${{ runner.os }}-${{ hashFiles('poetry.lock') }}

  - name: Create python virtualenv
    shell: bash
    run: python -m venv .venv
    if: steps.cache-venv.outputs.cache-hit != 'true'

  - name: Install dependencies
    run: source .venv/bin/activate && poetry install
    shell: bash
    if: steps.cache-venv.outputs.cache-hit != 'true'
